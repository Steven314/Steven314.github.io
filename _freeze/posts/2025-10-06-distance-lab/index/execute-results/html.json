{
  "hash": "2f203925aa4b91eb50f5c62645431609",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Distance Calculations Lab Using R\"\nauthor:\n  - name:\n      given: Steven\n      family: Carter\n    email: steven.carter4@utoledo.edu\n    url: https://slcarter.com\n    orcid: 0009-0008-5329-3763\n    affiliation: \n      name: University of Toledo\n      url: https://utoledo.edu\ndate: 2025-10-06\ncategories: [Distance, R, Spatial]\ndate-format: long\nformat:\n  html:\n    toc: true\n    toc-location: right\n    lightbox: true\n    fig-width: 6\n    fig-asp: 0.618\n    other-links:\n      - text: Presentation\n        icon: projector\n        href: https://slcarter.com/distance-calculations\nknitr:\n  opts_chunk: \n    collapse: true\n    comment: \"#>\"\n---\n\nThis lab walks through an example analysis using Lucas County housing data from the 1990s.\nIt was presented on October 6, 2025 to the SISS7020 PhD class at the University of Toledo.\n\n# Packages and Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(spData) # for the dataset\nlibrary(sf)\nlibrary(geosphere)\n\n# The sp format is old and may not work right, so convert to modern format.\nhouse_sf <- st_as_sf(house, 2834) |> \n  st_transform(crs = st_crs(\"NAD83\"))\n```\n:::\n\n\nIf you were not able to install the `{spData}` package, download the `house` dataset as an `.rds` file from Blackboard.\n\n::: {.callout-note title=\"Coordinate Systems\"}\nOriginally the `house` data is in a local coordinate system.\nIt has units for latitude and longitude with which I was unfamiliar.\nFor the sake of easier interpretation I've converted the coordinates to NAD83.\nIt will be fine for what we are doing today.\n:::\n\n# Scatter Plot\n\nJust to make sure the data looks right and to get an idea of what we are working with, let's plot the locations.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(house_sf) +\n  geom_sf(aes(color = price), alpha = 0.25) +\n  theme_bw() +\n  scale_color_continuous(\n    trans = \"log\",\n    labels = scales::label_currency(),\n    breaks = c(1e4, 3e4, 1e5, 5e5)\n  ) +\n  labs(\n    title = \"House Sales in Lucas County, 1993 - 1998\",\n    x = \"Longitude\",\n    y = \"Latitude\",\n    color = \"Sale Price\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fig-lucas-scatter-1.png){#fig-lucas-scatter width=576}\n:::\n:::\n\n\nThere are also a couple methods to achieve an interactive visualization which will not be covered here.^[Leaflet and Plotly each have R and Python interfaces to their JavaScript libraries. If you see a interactive map on a website, there is a good chance it was made with one of those libraries.]\n\n# Distance to City Center\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntoledo_lat <- 41.652778\ntoledo_lng <- -83.537778\n```\n:::\n\n\nWikipedia gives the center of Toledo as (41.652778, -83.537778).\n\nLet's establish a few distance metrics and compare the results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\neuclidean <- function(ref, new) {\n  sqrt(rowSums((ref - new)^2)) *\n    (pi / 180) * # convert to radians\n    6371 # km, the radius of the earth\n}\n\nmanhattan <- function(ref, new) {\n  rowSums(\n    abs(ref - new) * \n      (pi / 180) *\n      6371\n  )\n}\n\n# and also Haversine from `{geosphere}`\n```\n:::\n\n\nSo now we can calculate the distance to the city center with Euclidean, Manhattan, and Haversine distances.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhouse_sf_dist <- house_sf |> \n  mutate(\n    longitude = st_coordinates(geometry)[, 1],\n    latitude = st_coordinates(geometry)[, 2],\n    toledo_lat, \n    toledo_lng,\n    # redefine age\n    age = as.numeric(as.character(syear)) - yrbuilt\n  ) |> \n  mutate(\n    distance_euclidean = euclidean(\n      cbind(toledo_lat, toledo_lng), \n      cbind(latitude, longitude)\n    ),\n    distance_manhattan = manhattan(\n      cbind(toledo_lat, toledo_lng), \n      cbind(latitude, longitude)\n    ),\n    distance_haversine = geosphere::distHaversine(\n      cbind(toledo_lng, toledo_lat), \n      cbind(longitude, latitude)\n    ) / 1000 # convert meters to kilometers\n  )\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(house_sf_dist) +\n  geom_sf(\n    aes(color = distance_manhattan > 15), \n    alpha = 0.25\n  ) +\n  annotate(\n    x = toledo_lng, \n    y = toledo_lat, \n    geom = \"point\", \n    color = \"black\", \n    size = 2\n  ) +\n  theme_bw() +\n  labs(\n    title = \"House Sales in Lucas County, 1993 - 1998\",\n    x = \"Longitude\",\n    y = \"Latitude\",\n    color = \"Manhattan > 15km\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fig-lucas-center-1.png){#fig-lucas-center width=576}\n:::\n:::\n\n\n# Housing Model\n\n## Exploratory Data Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(\n  data = house_sf_dist,\n  aes(\n    x = distance_haversine, \n    y = price\n  )\n) +\n  geom_point(alpha = 0.1) +\n  scale_y_log10(\n    labels = scales::label_currency(\n      scale_cut = scales::cut_short_scale()\n    )\n  ) +\n  scale_x_log10() +\n  theme_bw() +\n  labs(\n    x = \"Haversine Distance (km)\",\n    y = \"Sale Price\",\n    title = \"Housing Sales in Lucas County, 1993-1998\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fig-price-dist-scatter-1.png){#fig-price-dist-scatter width=576}\n:::\n:::\n\n\nWith log-scales on both the $x$ and $y$ axes there seems to be a mostly linear relationship.\nThat is convenient.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(\n  data = house_sf_dist,\n  aes(\n    x = distance_haversine, \n    y = price\n  )\n) +\n  geom_point(alpha = 0.1) +\n  geom_smooth(method = \"lm\", formula = \"y ~ x\", se = FALSE) +\n  scale_y_log10(\n    labels = scales::label_currency(\n      scale_cut = scales::cut_short_scale()\n    )\n  ) +\n  scale_x_log10() +\n  theme_bw() +\n  labs(\n    x = \"Haversine Distance (km)\",\n    y = \"Sale Price\",\n    title = \"Housing Sales in Lucas County, 1993-1998\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fig-price-dist-scatter-lm-1.png){#fig-price-dist-scatter-lm width=576}\n:::\n:::\n\n\nWhat about the other variables?\nHow might housing prices vary for reasons other than distance?\nOr, how might distance to correlated with other variables?\n\nHere are the variables we have:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(house_sf_dist)\n#> Rows: 25,357\n#> Columns: 32\n#> $ price              <int> 303000, 92000, 90000, 330000, 185000, 100000, 43065…\n#> $ yrbuilt            <int> 1978, 1957, 1937, 1887, 1978, 1989, 1927, 1990, 187…\n#> $ stories            <fct> one+half, one, two, one+half, two, one, one, one+ha…\n#> $ TLA                <int> 3273, 920, 1956, 1430, 2208, 1232, 832, 3011, 1034,…\n#> $ wall               <fct> partbrk, metlvnyl, stucdrvt, wood, partbrk, wood, w…\n#> $ beds               <dbl> 4, 2, 3, 4, 3, 1, 2, 3, 3, 2, 4, 5, 4, 3, 3, 3, 3, …\n#> $ baths              <dbl> 3, 1, 1, 1, 2, 1, 1, 2, 1, 1, 2, 2, 2, 2, 1, 2, 2, …\n#> $ halfbaths          <dbl> 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, …\n#> $ frontage           <int> 177, 100, 192, 200, 241, 154, 320, 362, 500, 220, 2…\n#> $ depth              <int> 0, 0, 0, 217, 0, 1420, 0, 0, 990, 0, 0, 0, 0, 0, 0,…\n#> $ garage             <fct> attached, detached, attached, no garage, attached, …\n#> $ garagesqft         <int> 625, 308, 480, 0, 528, 1200, 360, 672, 624, 780, 61…\n#> $ rooms              <int> 12, 4, 7, 7, 7, 5, 4, 6, 7, 6, 6, 10, 8, 5, 6, 6, 6…\n#> $ lotsize            <int> 53496, 37900, 52900, 43560, 225800, 214100, 23500, …\n#> $ sdate              <int> 960423, 970421, 931101, 971223, 950807, 931101, 951…\n#> $ avalue             <int> 306514, 84628, 126514, 199228, 192514, 107914, 4902…\n#> $ s1993              <int> 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, …\n#> $ s1994              <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …\n#> $ s1995              <int> 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …\n#> $ s1996              <int> 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, …\n#> $ s1997              <int> 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, …\n#> $ s1998              <int> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, …\n#> $ syear              <fct> 1996, 1997, 1993, 1997, 1995, 1993, 1995, 1993, 199…\n#> $ age                <dbl> 18, 40, 56, 110, 17, 4, 68, 3, 119, 60, 41, 29, 0, …\n#> $ geometry           <POINT [°]> POINT (-83.87964 41.4169), POINT (-83.87716 4…\n#> $ longitude          <dbl> -83.87964, -83.87716, -83.87271, -83.86670, -83.838…\n#> $ latitude           <dbl> 41.41690, 41.41720, 41.41773, 41.42522, 41.42928, 4…\n#> $ toledo_lat         <dbl> 41.65278, 41.65278, 41.65278, 41.65278, 41.65278, 4…\n#> $ toledo_lng         <dbl> -83.53778, -83.53778, -83.53778, -83.53778, -83.537…\n#> $ distance_euclidean <dbl> 46.18378, 45.93799, 45.49884, 44.47400, 41.63927, 4…\n#> $ distance_manhattan <dbl> 64.24187, 63.93241, 63.37922, 61.87764, 58.26169, 6…\n#> $ distance_haversine <dbl> 38.74246, 38.56770, 38.25653, 37.32047, 35.29493, 3…\n```\n:::\n\n\nInformation about each variable can be found in the associated help file.\nIt can be opened by typing `?house` in the console.\nAlthough it is not the most thorough explanations of each variable, it is still helpful.\n\nWe can make a list of relationships to consider.\nIn these there are plenty of hypotheses.\n\n- As you move toward the city center, lots get smaller, thus prices go down. The converse also being the case.\n- Having more bedrooms, bathrooms, or stories would increase price.\n  - This may be correlated with lot size.\n- The city center may be older and perhaps older houses have lower prices.\n\nAll of those are statements we can test.\n\nWe can also come up with statements we can't test with the data currently at hand.\n\n- Houses close to highways have lower value.\n- Proximity to amenities, such as schools, parks, and entertainment, can contribute to changes in housing prices.\n- A house of poor quality would have lower value.\n\n### Spatial Variation\n\n::: {.callout-note}\nSpatial variance is something I would expect us to cover in an upcoming spatial statistics class.\nFor now, I'll cover how some variables are correlated with distance from the city center and price.\n:::\n\n#### Age\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(\n  data = house_sf_dist,\n  aes(\n    x = yrbuilt,\n    y = price\n  )\n) + \n  geom_point(alpha = 0.1) +\n  scale_y_log10(\n    labels = scales::label_currency(\n      scale_cut = scales::cut_short_scale()\n    )\n  ) +\n  theme_bw() +\n  labs(\n    x = \"Year Build\",\n    y = \"Sale Price\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fig-price-age-1.png){#fig-price-age width=576}\n:::\n:::\n\n\nLook at the final years.\nSomething weird seems to be happening with houses built and sold at the end of the dataset.\nThere houses would have a very young age.\n(Some houses even have a negative age.)\nPerhaps this means the sale price is reflecting the price of an empty lot and not the price of a house.\nThis could be a reason to exclude houses with an age less than some threshold, say 2 years.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nggplot(\n  data = house_sf_dist,\n  aes(\n    x = distance_haversine,\n    y = yrbuilt\n  )\n) + \n  geom_point(alpha = 0.1) +\n  scale_x_log10() +\n  theme_bw() +\n  labs(\n    x = \"Distance to City Center (km)\",\n    y = \"Year Built\"\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/fig-age-dist-1.png){#fig-age-dist width=576}\n:::\n:::\n\n\n::: {.callout-caution title=\"Question\"}\nWhat might have caused those two bands where there are no houses being build (or at least sold)?\n:::\n\n## Linear Model\n\nThe `lm()` function can be used for a linear model.\nIt takes a dataset for training and a formula.\n\n::: {.callout-important title=\"Splitting Data\"}\nWhen training a model to be used for predicting new data you should split into training and testing (and potentially validation) sets.\nWhen there is a spatial component you may also want to consider the spatial relationships.\n\n- [*Spatial Data Science*](https://r-spatial.org/book) seems like a good resource for more info on this.\n  I have yet to read it, but it is on the list for the future.\n- [*Tidy Modeling with R*, chapter 5](https://www.tmwr.org/splitting) is also a good resource for information on training a model.\n  I have read this whole book and can recommend it.\n- [`{spatialsample}`](https://spatialsample.tidymodels.org) is a package in the `tidymodels` and `tidyverse` ecosystem that can perform spatial sampling.\n  I haven't used it yet, but likely will within the next year.\n:::\n\nFirst let's try a simple model with just distance and taking logs of distance and price.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsimple_model <- lm(\n  data = house_sf_dist,\n  formula = log(price) ~ log(distance_haversine)\n)\n\nsimple_model |> \n  summary()\n#> \n#> Call:\n#> lm(formula = log(price) ~ log(distance_haversine), data = house_sf_dist)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -3.6031 -0.2995  0.0568  0.3500  2.4195 \n#> \n#> Coefficients:\n#>                         Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)             9.248718   0.012482   740.9   <2e-16 ***\n#> log(distance_haversine) 0.881602   0.005961   147.9   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 0.559 on 25355 degrees of freedom\n#> Multiple R-squared:  0.4631,\tAdjusted R-squared:  0.4631 \n#> F-statistic: 2.187e+04 on 1 and 25355 DF,  p-value: < 2.2e-16\n```\n:::\n\n\nThis has a decent $R^2$ value.\nHowever, we can't trust the model coefficients.\nUsing only distance isn't a very good model.\n\nWhy?\n\nOther factors have spatial variance.\nDistance isn't the only thing changing between observations.\nWe have an endogeneity issue or omitted variable bias.\nThat should sound familiar from an econometrics class.\nIf not, you should be covering that soon.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbig_model <- lm(\n  data = house_sf_dist,\n  formula = log(price) ~ log(distance_haversine) +\n    lotsize +\n    beds +\n    baths +\n    halfbaths +\n    stories +\n    garage +\n    TLA +\n    age +\n    syear\n)\n\nbig_model |> \n  summary()\n#> \n#> Call:\n#> lm(formula = log(price) ~ log(distance_haversine) + lotsize + \n#>     beds + baths + halfbaths + stories + garage + TLA + age + \n#>     syear, data = house_sf_dist)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -2.88571 -0.15787  0.05206  0.23625  2.58261 \n#> \n#> Coefficients:\n#>                           Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)              9.481e+00  2.368e-02 400.384  < 2e-16 ***\n#> log(distance_haversine)  4.309e-01  6.338e-03  67.986  < 2e-16 ***\n#> lotsize                 -4.381e-07  9.750e-08  -4.493 7.05e-06 ***\n#> beds                     1.989e-02  4.745e-03   4.191 2.79e-05 ***\n#> baths                   -3.952e-02  8.022e-03  -4.927 8.42e-07 ***\n#> halfbaths                7.278e-02  6.622e-03  10.991  < 2e-16 ***\n#> storiesbilevel          -1.842e-01  1.873e-02  -9.832  < 2e-16 ***\n#> storiesmultilvl         -7.237e-02  1.579e-02  -4.582 4.63e-06 ***\n#> storiesone+half         -3.144e-02  8.927e-03  -3.522 0.000429 ***\n#> storiestwo               9.575e-02  6.928e-03  13.820  < 2e-16 ***\n#> storiestwo+half          1.671e-01  2.857e-01   0.585 0.558637    \n#> storiesthree            -6.321e-02  2.861e-01  -0.221 0.825137    \n#> garagebasement           5.417e-01  4.653e-02  11.641  < 2e-16 ***\n#> garageattached           4.064e-01  9.997e-03  40.648  < 2e-16 ***\n#> garagedetached           4.054e-01  7.841e-03  51.703  < 2e-16 ***\n#> garagecarport            3.094e-01  2.837e-02  10.907  < 2e-16 ***\n#> TLA                      3.803e-04  7.851e-06  48.443  < 2e-16 ***\n#> age                     -7.909e-03  1.496e-04 -52.866  < 2e-16 ***\n#> syear1994                5.699e-02  9.693e-03   5.879 4.18e-09 ***\n#> syear1995                9.373e-02  9.468e-03   9.899  < 2e-16 ***\n#> syear1996                1.061e-01  9.162e-03  11.581  < 2e-16 ***\n#> syear1997                1.566e-01  9.099e-03  17.213  < 2e-16 ***\n#> syear1998                2.397e-01  9.370e-03  25.582  < 2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 0.4039 on 25334 degrees of freedom\n#> Multiple R-squared:   0.72,\tAdjusted R-squared:  0.7198 \n#> F-statistic:  2961 on 22 and 25334 DF,  p-value: < 2.2e-16\n```\n:::\n\n\nThis model improves the $R^2$ value.\nCompare the coefficiencts for $\\log(d_\\text{haversine})$.\nThe coefficient in the second model is only half of that in the first model.\n\nThis means that some of the variation in price is better explained by the other variables we included.\n\n## Model Conclusion\n\nIf we are happy with the reasoning for our model (i.e. we don't expect any omitted variable bias or other statistical issues), we could attempt to claim a causal effect of distance on housing prices.\n\nThe predictions can be found with the `predict()` function.\n\nNotice how we have to use `exp()` wrapping `predict`.\nThis is because we used `log(price)`.\nWe need to reverse the logarithm.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhouse_sf_dist |> \n  as_tibble() |> \n  mutate(\n    price_hat = exp(predict(\n      big_model, \n      data = house_sf_dist\n    ))\n  ) |> \n  select(price, price_hat)\n#> # A tibble: 25,357 × 2\n#>     price price_hat\n#>     <int>     <dbl>\n#>  1 303000   311781.\n#>  2  92000   112826.\n#>  3  90000   140216.\n#>  4 330000    52063.\n#>  5 185000   213576.\n#>  6 100000   128987.\n#>  7  43065    79742.\n#>  8 305000   246901.\n#>  9  56493    52171.\n#> 10  50000    89339.\n#> # ℹ 25,347 more rows\n```\n:::\n\n\n\n## More Complicated Models\n\nThe actual model technique may not necessarily be more complicated, but the feature engineering ([TMwR chapter 8](https://www.tmwr.org/recipes)) is fancier.\n\n- If a house in the same neighborhood (or at least nearby) sold the previous year, the housing prices in the neighborhood may be influenced. The proximity with a recently sold house and how similar (also distance, but in non-spatial dimensions) could affect how strong that influence is.\n  - I couldn't find a paper that covered this, but I didn't look for very long.\n- Proximity to other points-of-interest, such as schools, parks, entertainment, or highway access, can be considered.\n  - [Measuring Highway Impacts on House Prices Using Spatial Regression](https://www.tandfonline.com/doi/abs/10.1080/10835547.2015.12091876)\n- Using travel time instead of straight line distance.\n  - [Road distance and travel time for an improved house price Kriging predictor](https://www.tandfonline.com/doi/full/10.1080/10095020.2018.1503775)",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}